# {{ ansible_managed }}

{% if funkwhale_nginx_tls_enabled %}
server {
    listen {{ funkwhale_nginx_listen_port }};
    listen [::]:{{ funkwhale_nginx_listen_port }};

    server_name {{ funkwhale_hostname }};

    location / { return 301 https://$host$request_uri; }
}
{% endif %}

server {
{% if funkwhale_nginx_tls_enabled %}
    listen {{ funkwhale_nginx_tls_listen_port }} ssl http2;
    listen [::]:{{ funkwhale_nginx_tls_listen_port }} ssl http2;
{% else %}
    listen {{ funkwhale_nginx_listen_port }};
    listen [::]:{{ funkwhale_nginx_listen_port }};
{% endif %}

    server_name {{ funkwhale_hostname }};

{% if funkwhale_nginx_tls_enabled %}
    # SSL/TLS
    ssl_certificate {{ funkwhale_nginx_tls_cert_path }};
    ssl_certificate_key {{ funkwhale_nginx_tls_key_path }};

{% if funkwhale_nginx_tls_config_raw %}
    {{ funkwhale_nginx_tls_config_raw | indent(4) }}
{% endif %}

    add_header Strict-Transport-Security "max-age=63072000; preload";
{% endif %}

{% if funkwhale_nginx_csp_policy %}
    # Security-related headers
    add_header Content-Security-Policy "{{ funkwhale_nginx_csp_policy }}";
{% endif %}

    root {{ funkwhale_front_dir }};

    # Compression
{% if funkwhale_nginx_compression_enabled %}
    gzip on;
    gzip_comp_level 5;
    gzip_min_length 256;
    gzip_proxied any;
    gzip_vary on;

    gzip_types
    application/javascript
    application/vnd.geo+json
    application/vnd.ms-fontobject
    application/x-font-ttf
    application/x-web-app-manifest+json
    font/opentype
    image/bmp
    image/svg+xml
    image/x-icon
    text/cache-manifest
    text/css
    text/plain
    text/vcard
    text/vnd.rim.location.xloc
    text/vtt
    text/x-component
    text/x-cross-domain-policy;
{% else %}
    gzip off;
{% endif %}

    # Locations

    location / {
        include /etc/nginx/funkwhale_proxy.conf;
        client_max_body_size {{ funkwhale_nginx_max_body_size }};
        proxy_pass http://{{ funkwhale_gunicorn_listen_ip }}:{{ funkwhale_gunicorn_listen_port }}/;
    }

    location /front/ {
        alias {{ funkwhale_front_dir }}/;
        expires 30d;
        add_header Pragma public;
        add_header Cache-Control "public, must-revalidate, proxy-revalidate";
        add_header Service-Worker-Allowed "/";
    }

    location /federation/ {
        include /etc/nginx/funkwhale_proxy.conf;
        proxy_pass http://{{ funkwhale_gunicorn_listen_ip }}:{{ funkwhale_gunicorn_listen_port }}/federation/;
    }

    # Subsonic API
    location /rest/ {
        include /etc/nginx/funkwhale_proxy.conf;
        proxy_pass http://{{ funkwhale_gunicorn_listen_ip }}:{{ funkwhale_gunicorn_listen_port }}/api/subsonic/rest/;
    }

    location /.well-known/ {
        include /etc/nginx/funkwhale_proxy.conf;
        proxy_pass http://{{ funkwhale_gunicorn_listen_ip }}:{{ funkwhale_gunicorn_listen_port }}/.well-known/;
    }

    location /media/ {
        alias {{ funkwhale_media_dir }}/;
    }

{% if funkwhale_external_storage_enabled %}
    location ~ /_protected/media/(.+) {
        # See #932
        proxy_set_header Authorization "";
        internal;
        proxy_pass $1;
    }
{% else %}
    location /_protected/media {
        internal;
        alias {{ funkwhale_media_dir }};
    }
{% endif %}

    location /_protected/music {
        internal;
        alias {{ funkwhale_music_dir }};
    }

    location /staticfiles/ {
        alias {{ funkwhale_static_dir }}/;
    }

{% if not funkwhale_django_admin_enabled %}
    location /api/admin/ {
        return 403;
    }
{% endif %}

{% if funkwhale_nginx_config_raw %}
    {{ funkwhale_nginx_config_raw | indent(4) }}
{% endif %}
}
